/*
 * clock_cleaner.c
 *
 *  Created on: Mar 24, 2020
 *      Author: rypay
 */


/***************************** Include Files **********************************/
#include "xparameters.h"
#include "xiicps.h"
#include "xil_printf.h"
#include "i2c.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "sleep.h"

/************************** Constant Definitions ******************************/

/*
 * The following constants map to the XPAR parameters created in the
 * xparameters.h file. They are defined here such that a user can easily
 * change all the needed parameters in one place.
 */
#define IIC_DEVICE_ID				XPAR_XIICPS_0_DEVICE_ID
#define CLOCK_CLEANER_REGISTER_LEN  0x03FF
/*
 * The slave address to send to and receive from.
 */
#define CLOCK_CLEANER_DEVICE_ID		XPAR_XIICPS_0_DEVICE_ID
#define CLOCK_CLEANER_SLAVE_ADDR	0x7C
#define CLOCK_CLEANER_SCLK_RATE		100000
#define CLOCK_CLEANER_INIT_REG		0x0039
#define CLOCK_CLEANER_INIT_VAL		0x0F
#define CLOCK_CLEANER_STOP_VAL		0x00

/*
 * The following constant controls the length of the buffers to be sent
 * and received with the IIC.
 */
#define TEST_BUFFER_SIZE	1024

volatile u8 clock_cleaner_i2c_ready = 0;
volatile u8 clock_cleaner_ready 	= 0;

/**************************** Type Definitions ********************************/


/************************** Function Prototypes *******************************/

/************************** Variable Definitions ******************************/
volatile u8 init_clock_cleaner_settings[] = {0x09,0x50,0x00,0x60,0x60,0x01,0x7c,0x01,0x03,0x00,0x00,0x00,0x01,0xe9,0x00,0x01,0xe9,0x00,0x5b,0xb0,
									0x00,0x5b,0xb0,0x7d,0x6d,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0x0b,0x3f,0x00,0x18,0x00,
									0x00,0x00,0x00,0x00,0x01,0x00,0x00,0xd0,0x0f,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,
									0x00,0x44,0x44,0x01,0x00,0x02,0x00,0x00,0x0c,0x00,0x00,0x0c,0x00,0x00,0x0c,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0xe0,0x02,0x2b,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x13,0x00,0x00,0x13,0x00,
									0x00,0x53,0x27,0xcc,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
									0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x00,0x04,0x12,0x01,0x9d,0x51,0x01,
									0x9d,0x51,0x3f,0xff,0x00,0x21,0x0f,0x07,0x01,0x0b,0xde};


XIicPs Iic;		/**< Instance of the IIC Device */

/*
 * The following buffers are used in this example to send and receive data
 * with the IIC.
 */
u8 SendBuffer[TEST_BUFFER_SIZE];    /**< Buffer for Transmitting Data */
u8 RecvBuffer[TEST_BUFFER_SIZE];    /**< Buffer for Receiving Data */


/******************************* Functions ************************************/
u8 clock_cleaner_i2c_init()
{
	u32 Status;
	XIicPs_Config *Config;
	u32 Index;
	/*
	 * Initialize the IIC driver so that it's ready to use
	 * Look up the configuration in the config table,
	 * then initialize it.
	 */
	Config = XIicPs_LookupConfig(CLOCK_CLEANER_DEVICE_ID);
	if (NULL == Config) {
		return XST_FAILURE;
	}

	Status = XIicPs_CfgInitialize(&Iic, Config, Config->BaseAddress);
	if (Status != XST_SUCCESS) {
		return 0;
	}

	usleep(3000000);

	/*
	 * Perform a self-test to ensure that the hardware was built correctly.
	 */
	Status = XIicPs_SelfTest(&Iic);
	if (Status != XST_SUCCESS) {
		return 0;
	}

	/*
	 * Set the IIC serial clock rate.
	 */
	XIicPs_SetSClk(&Iic, CLOCK_CLEANER_SCLK_RATE);

	/*
	 * Initialize the send buffer bytes with a pattern to send and the
	 * the receive buffer bytes to zero to allow the receive data to be
	 * verified.
	 */
	for (Index = 0; Index < TEST_BUFFER_SIZE; Index++) {
			SendBuffer[Index] = (Index % TEST_BUFFER_SIZE);
			RecvBuffer[Index] = 0;
	}

	usleep(100000);

	printf("i2c initialized\n");
	return 1;
}

u8 clock_cleaner_init(void){
	u8 flag = 1;

	//write all registers specified in init array
	for(u32 i = 0; i < sizeof(init_clock_cleaner_settings)/sizeof(init_clock_cleaner_settings[0]); i++){
		flag  = i2c_write(&Iic, CLOCK_CLEANER_SLAVE_ADDR, i, init_clock_cleaner_settings[i], SendBuffer);
		usleep(500);
	}

	if(flag == 1){
		printf("clock cleaner set up\n");
	} else {
		printf("failed to set up clock cleaner\n");
	}
	return flag;
}

u8 clock_cleaner_start(void){
	if(clock_cleaner_i2c_ready != 1){
		printf("initializing i2c...\n");
		clock_cleaner_i2c_ready = clock_cleaner_i2c_init();
	}

	if(clock_cleaner_ready != 1){
		printf("setting up clock cleaner...\n");
		clock_cleaner_ready = clock_cleaner_init();
	}

	if(clock_cleaner_ready && clock_cleaner_i2c_ready){
		u8 flag = 1;
		//write all registers specified in init array
		flag  = i2c_write_readvalid(&Iic, CLOCK_CLEANER_SLAVE_ADDR, CLOCK_CLEANER_INIT_REG, CLOCK_CLEANER_INIT_VAL, SendBuffer, RecvBuffer);
		if(flag == 0){
			return 0;
		}

		printf("clock cleaner operational\n");
		return 1;
	} else {
		return 0;
	}
}

u8 clock_cleaner_stop(void){
	if(clock_cleaner_i2c_ready != 1){
		printf("initializing i2c...\n");
		clock_cleaner_i2c_ready = clock_cleaner_i2c_init();
	}

	if(clock_cleaner_ready != 1){
		printf("setting up clock cleaner...\n");
		clock_cleaner_ready = clock_cleaner_init();
	}

	if(clock_cleaner_ready && clock_cleaner_i2c_ready){
		u8 flag = 1;
		//write all registers specified in init array
		flag  = i2c_write_readvalid(&Iic, CLOCK_CLEANER_SLAVE_ADDR, CLOCK_CLEANER_INIT_REG, CLOCK_CLEANER_STOP_VAL, SendBuffer, RecvBuffer);
		if(flag == 0){
			return 0;
		}

		printf("clock cleaner stopped\n");
		return 1;
	} else {
		return 0;
	}
}
